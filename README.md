# l2tp-universal-script
Универсальный Bash-скрипт для автоматизированной настройки L2TP VPN сервера на Linux с множественными исходящими IP-адресами и автоматической выдачей всех данных для клиентов после установки.

## Новое: универсальные бэкапы и безопасный откат (rollback)
Скрипт теперь всегда запускается с меню:
- 1) Установка L2TP — перед любыми изменениями создаётся полный бэкап состояния
- 2) Откат (Rollback) — восстановление последнего или выбранного бэкапа

### Что входит в бэкап
Бэкап создаётся в каталоге /root/l2tp-universal-backup-<YYYYMMDD-HHMMSS> и дублируется ссылкой /root/l2tp-universal-backup-latest.
Содержимое бэкапа:
- Конфигурационные файлы: /etc/xl2tpd/xl2tpd.conf, /etc/ipsec.conf, /etc/ipsec.secrets, /etc/ppp/options.xl2tpd, /etc/ppp/chap-secrets, /etc/sysctl.conf (если файла не было — помечается .absent)
- iptables и ip6tables: полные дампы через iptables-save/ip6tables-save
- Полный снимок sysctl (sysctl -a)
- Состояние сервисов ipsec, xl2tpd (enabled/disabled и active/inactive)

### Логика отката
- Восстановление файлов: если в бэкапе файл был, он копируется обратно; если в бэкапе отмечен .absent — файл удаляется, если он появился
- Восстановление iptables: строго через iptables-restore/ip6tables-restore из дампов бэкапа
- Восстановление sysctl: изменяются только ключи, которые трогает скрипт (net.ipv4.ip_forward, net.ipv4.conf.all.accept_redirects, net.ipv4.conf.all.send_redirects)
- Восстановление сервисов: возвращаются enabled/disabled и состояние (перезапуск или остановка)

### Замечания безопасности
- Храните бэкапы только на доверенном хосте (в них есть чувствительные данные конфигурации)
- Не изменяйте содержимое бэкапа вручную, чтобы не нарушить консистентность
- Перед откатом убедитесь, что вы понимаете, какие текущие изменения будут перезаписаны
- Откат заменяет только то, что создавал/менял скрипт, не трогая посторонние файлы

## Быстрая установка
```bash
wget -O - https://raw.githubusercontent.com/Mortyo666/l2tp-universal-script/main/l2tp-universal.sh | bash
```
При запуске будет предложено выбрать: установка или откат (можно также использовать ключи --install или --rollback без меню).

## Явный пул исходящих IP и фильтрация авто-IP
- Можно задать явный список исходящих IP через переменную окружения OUTGOING_IPS:
  Пример: OUTGOING_IPS="1.2.3.4 5.6.7.8" bash l2tp-universal.sh
- В этом режиме используется ТОЛЬКО заданный список; служебные/локальные/авто-IP не затрагиваются.
- В авто-режиме скрипт фильтрует исходящие IP:
  - Исключаются служебные: 10.180.1.1, 10.180.2.1, 10.180.5.1
  - Исключаются локальные диапазоны: 10.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, 127.0.0.0/8, 169.254.0.0/16, 100.64.0.0/10
- Распределение исходящих IP по пользователям:
  - Каждому пользователю выдается уникальный OUTGOING_IP из списка по порядку
  - Если IP меньше, чем пользователей — выводится предупреждение; оставшиеся пользователи используют первый IP
  - Если IP больше, чем пользователей — используются только нужные по количеству

## Что выдает скрипт
После установки вы получите:
- Username (имя пользователя)
- Password (пароль)
- Internal IP (внутренний IP)
- Outgoing IP (исходящий IP)
- Все данные сохраняются в файл в /root/l2tp-clients-<date>.txt

## Параметры пула клиентов
- Подсеть: по умолчанию 10.99.0.0/24 (настраивается через POOL_SUBNET)
- Диапазон: 10.99.0.10 - 10.99.0.250 (POOL_START / POOL_END)

## Требования
- Linux сервер (Ubuntu, Debian, CentOS)
- Root права
- Минимум 1 GB RAM
- Открытые порты: UDP 500, 4500, 1701

## Проверка целостности скачивания
Файл l2tp-universal.sh теперь хранится полностью (устранены обрывы содержимого). Если при скачивании видите частичный вывод, используйте ссылку Raw или ключ --install/--rollback.

## Лицензия
MIT
